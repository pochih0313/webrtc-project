<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ClientA</title>
</head>

<body>
    <video id="localVideo" autoplay muted style="width:40%;"></video>
    <video id="remoteVideo" autoplay style="width:40%;"></video>

    <br />

    <input type="button" id="start" onclick="start(true)" value="Start Video"></input>

    <button id="connectButton" name="connectButton" class="buttonleft">
        Connect
    </button>
    <button id="disconnectButton" name="disconnectButton" class="buttonright">
        Disconnect
    </button>

    <div class="messagebox">
        <label for="message">Enter a message:
            <input type="text" name="message" id="message" placeholder="Message text"
                inputmode="latin" size=60 maxlength=100> 
        </label>
        <button id="sendButton" name="sendButton" class="buttonright">
            Send
        </button>
    </div>

    <div class="messagebox" id="receivebox">
        <p> Messages received:</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/0.3.9/peer.min.js"></script>
    <script>
        var peer = new Peer('A', { host: '10.0.2.15', port: 9000, path: '/api' });
        var localVideo;
        var localStream;

        peer.on('open', function (id) {
            console.log('My peer ID is: ' + id);
        });

        peer.on('connection', (conn) => {
            //video
            localVideo = document.getElementById('localVideo');
            remoteVideo = document.getElementById('remoteVideo');
            
            var constraints = {
                video: true,
                audio: true,
            };
            
            function getUserMediaSuccess(stream) {
                localStream = stream;
                localVideo.srcObject = stream;
            }
            
            function errorHandler(error) {
                console.log(error);
            }

            if(navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia(constraints).then(getUserMediaSuccess).catch(errorHandler);
            } else {
                alert('Your browser does not support getUserMedia API');
            }
            

            //text message
            var con = conn;
            
            function sendMessage(){
                var message = messageInputBox.value;
                conn.send(message);
                messageInputBox.value = "";
                messageInputBox.focus();
            }

            sendButton = document.getElementById('sendButton');
            messageInputBox = document.getElementById('message');
            sendButton,addEventListener('click', sendMessage, false);
            receiveBox = document.getElementById('receivebox');

            conn.on('open', () => {
                // 有任何人加入這個會話時，就會觸發
                console.log(`${con.peer} is connected with me`);
            });
            conn.on('data', function (data) {
                // 當收到訊息時會執行
                console.log(`${con.peer} : ` + data);
                //conn.send('HI I am A');
                var el = document.createElement("p");
                var txtNode = document.createTextNode(data);
                el.appendChild(txtNode);
                receiveBox.appendChild(el);
            });

        });
    </script>
</body>

</html>